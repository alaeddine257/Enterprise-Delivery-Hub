name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      - name: Initialize database schema
        run: |
          python - <<'PY'
          from app import create_app
          app = create_app()
          with app.app_context():
              from app.db import get_db
              db = get_db()
              db.executescript(open('app/schema.sql').read())
          PY

      - name: Seed test data
        run: |
          python - <<'PY'
          from app import create_app
          app = create_app()
          with app.app_context():
            from app.db import get_db
            from datetime import datetime
            now = datetime.utcnow().isoformat()
            db = get_db()
            # Insert a department with required fields
            db.execute(
              "INSERT OR IGNORE INTO departments (name, head, created_at) VALUES (?, ?, ?)",
              ("IT", "CI Bot", now),
            )
            # Insert an employee to satisfy foreign keys
            db.execute(
              "INSERT OR IGNORE INTO employees (full_name, email, role, department_id, created_at) VALUES (?, ?, ?, ?, ?)",
              ("CI User", "ci@example.com", "Engineer", 1, now),
            )
            # Insert a project with required fields
            db.execute(
              "INSERT OR IGNORE INTO projects (name, owner, status, department_id, budget, created_at) VALUES (?, ?, ?, ?, ?, ?)",
              ("Project A", "CI Bot", "Backlog", 1, 0, now),
            )
            # Insert a task with required fields
            db.execute(
              "INSERT OR IGNORE INTO tasks (project_id, title, assignee_id, priority, status, due_date, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)",
              (1, "Task 1", 1, "Medium", "Not Started", now[:10], now),
            )
            # Insert a risk with required fields
            db.execute(
              "INSERT OR IGNORE INTO risks (project_id, title, impact, likelihood, mitigation, status, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)",
              (1, "Risk 1", "Medium", "Low", "Monitor", "Open", now),
            )
            db.commit()
          PY

      - name: Run tests
        run: pytest --cov=app --cov-report=term-missing

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/flask-app:latest

      - name: Deploy on VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 172.213.211.71
          username: azureuser
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd ~/Enterprise-Delivery-Hub
            docker compose pull
            docker compose up -d